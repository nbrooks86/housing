DROP VIEW "HOUSING"."LLP_HOUSING_DATA";
CREATE VIEW "HOUSING"."LLP_HOUSING_DATA" AS 
SELECT DISTINCT 
	 A.SLCM_ID,
	 B.LLP_PREFERENCE,
	 B.Rank,
	 B1.VALUE_STRING AS LLP_PREFERENCE_1,
	 B2.VALUE_STRING AS LLP_PREFERENCE_2,
	 B3.VALUE_STRING AS LLP_PREFERENCE_3,
	 C.COMPLETE_DATE AS "HOUSING_APPLICATION_DATE",
	 F.VALUE_STRING AS SELF_REPORTED_MAJOR,
	 CASE 
		WHEN G.VALUE_BOOLEAN = '1' 
		THEN 'Y' 
		ELSE 'N' 
	 END AS "LLP_OFFER_MADE",
	 H.VALUE_STRING AS "LLP_OFFERED",
	 I.VALUE_STRING AS "LLP_OFFER_ACCEPTED_DECLINED",
	 -- 2015-04-01 added based on request ITSR0005130 - Sumaira (student intern)
	 C.CANCEL_DATE AS "APPLICATION_CANCEL_DATE",
	 J.VALUE_STRING AS "OFFER_STATUS",
	 T.VALUE_STRING AS "TSHIRT_SIZE",
	 CASE 
		WHEN (C.TERM_ID = '73' AND R.TERM_SESSION_ID = '84') 
		THEN R.ROOMSPACE_DESCRIPTION 
		WHEN (C.TERM_ID = '79' AND R2.TERM_SESSION_ID = '92') 
		THEN R2.ROOMSPACE_DESCRIPTION 
		WHEN (C.TERM_ID = '82' AND R3.TERM_SESSION_ID = '97') 
		THEN R3.ROOMSPACE_DESCRIPTION 
		WHEN (C.TERM_ID = '88' AND R4.TERM_SESSION_ID = '107') 
		THEN R4.ROOMSPACE_DESCRIPTION 
		ELSE NULL 
	 END AS "ROOM_SPACE_DESC",
	 APY.LLP_APPLICATION_YEAR,
	 v.VALUE_DATE AS "LLP_OFFER_DATE",
	 w.VALUE_DATE AS "LLP_OFFER_ACCEPT_DATE" 
FROM "CORE_LEVEL1"."HOUSING_ENTRY" A 
LEFT OUTER JOIN "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION" C ON A.ENTRY_ID = C.ENTRY_ID -- 2015-04-01 added based on request ITSR0005130 - Sumaira (student intern)
 
LEFT OUTER JOIN ( 
	select distinct 
	ENTRY_APPLICATION_ID,
	VALUE_STRING AS LLP_PREFERENCE,
	'1' AS RANK 
	from "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" 
	where CUSTOM_FIELD_DEFINITION_ID = '48' 
	UNION 
	select distinct 
	ENTRY_APPLICATION_ID,
	VALUE_STRING AS LLP_PREFERENCE,
	'2' AS RANK 
	from "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" 
	where CUSTOM_FIELD_DEFINITION_ID = '49' 
	and VALUE_STRING <> '' 
	UNION 
	select distinct ENTRY_APPLICATION_ID,
	VALUE_STRING AS LLP_PREFERENCE,
	'3' AS RANK 
	from "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" 
	where CUSTOM_FIELD_DEFINITION_ID = '50' 
	and VALUE_STRING <> '') B ON B.ENTRY_APPLICATION_ID = C.ENTRY_APPLICATION_ID 
	
LEFT OUTER JOIN "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" B1 
ON B1.ENTRY_APPLICATION_ID = C.ENTRY_APPLICATION_ID 
AND B1.CUSTOM_FIELD_DEFINITION_ID = '48' 

LEFT OUTER JOIN "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" B2 
ON B2.ENTRY_APPLICATION_ID = C.ENTRY_APPLICATION_ID 
AND B2.CUSTOM_FIELD_DEFINITION_ID = '49' 

LEFT OUTER JOIN "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" B3 
ON B3.ENTRY_APPLICATION_ID = C.ENTRY_APPLICATION_ID 
AND B3.CUSTOM_FIELD_DEFINITION_ID = '50' 

LEFT OUTER JOIN "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" F 
ON F.ENTRY_APPLICATION_ID = C.ENTRY_APPLICATION_ID 
AND F.CUSTOM_FIELD_DEFINITION_ID = '29' 
 
LEFT OUTER JOIN "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" G 
ON G.ENTRY_APPLICATION_ID = C.ENTRY_APPLICATION_ID 
AND G.CUSTOM_FIELD_DEFINITION_ID = '56' 

LEFT OUTER JOIN "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" H 
ON H.ENTRY_APPLICATION_ID = C.ENTRY_APPLICATION_ID 
AND H.CUSTOM_FIELD_DEFINITION_ID = '57' 

LEFT OUTER JOIN "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" I 
ON I.ENTRY_APPLICATION_ID = C.ENTRY_APPLICATION_ID 
AND I.CUSTOM_FIELD_DEFINITION_ID = '59' 
 
LEFT OUTER JOIN "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" J 
ON J.ENTRY_APPLICATION_ID = C.ENTRY_APPLICATION_ID 
AND J.CUSTOM_FIELD_DEFINITION_ID = '65' 

LEFT OUTER JOIN "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" T 
ON T.ENTRY_APPLICATION_ID = C.ENTRY_APPLICATION_ID 
AND T.CUSTOM_FIELD_DEFINITION_ID = '51' 
 
LEFT OUTER JOIN "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" v 
ON V.ENTRY_APPLICATION_ID = C.ENTRY_APPLICATION_ID 
AND v.CUSTOM_FIELD_DEFINITION_ID = '60' --offer date
 
LEFT OUTER JOIN "CORE_LEVEL1"."HOUSING_ENTRY_APPLICATION_CUSTOM_FIELD" w 
ON W.ENTRY_APPLICATION_ID = C.ENTRY_APPLICATION_ID 
AND w.CUSTOM_FIELD_DEFINITION_ID = '61' -- accept date
 
LEFT OUTER JOIN "CORE_LEVEL2"."HOUSING_BOOKINGS" R 
on R.ENTRY_ID = A.ENTRY_ID 
AND R.TERM_SESSION_ID = '84' 
AND R.ENTRY_STATUS_CODE='2' 
AND C.TERM_ID = '73' -- Applications for 2016,2017,2018  
 
LEFT OUTER JOIN "CORE_LEVEL2"."HOUSING_BOOKINGS" R2 
on R2.ENTRY_ID = A.ENTRY_ID 
AND R2.TERM_SESSION_ID = '92' 
AND R2.ENTRY_STATUS_CODE='2' 
AND C.TERM_ID = '79' 

LEFT OUTER JOIN "CORE_LEVEL2"."HOUSING_BOOKINGS" R3 
on R3.ENTRY_ID = A.ENTRY_ID 
AND R3.TERM_SESSION_ID = '97' 
AND R3.ENTRY_STATUS_CODE='2' 
AND C.TERM_ID = '82' 

LEFT OUTER JOIN "CORE_LEVEL2"."HOUSING_BOOKINGS" R4 
on R4.ENTRY_ID = A.ENTRY_ID 
AND R4.TERM_SESSION_ID = '107' 
AND R4.ENTRY_STATUS_CODE ='2' 
AND C.TERM_ID = '88' 

LEFT OUTER JOIN "HOUSING"."LLP_TERM_TO_APPLICATION_YEAR" APY 
ON C.TERM_ID = APY.TERM_ID 

WHERE C.TERM_ID IN ('73', '79', '82', '88') 
AND A.TESTING = 0 --Malik C. 7/9/2018 Added these filters to exclude applications with blank rows

AND C.PORTAL_TRACKING_ONLY <> '1' 
AND B.LLP_PREFERENCE <> '' 

WITH READ ONLY